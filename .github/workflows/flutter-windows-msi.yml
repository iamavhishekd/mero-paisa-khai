name: Flutter Windows MSI Build

on:
  workflow_dispatch:
    inputs:
      flutter-version:
        description: "Flutter version to use"
        required: true
        default: "3.38.9"
      build-type:
        description: "Build type (release/debug)"
        required: true
        default: "release"
      msi-name:
        description: "Output MSI file name"
        required: true
        default: "MyFlutterApp.msi"

jobs:
  build-msi:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ github.event.inputs.flutter-version }}
          cache: true

      - run: flutter config --enable-windows-desktop
      - run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --${{ github.event.inputs['build-type'] }}

      # Install WiX
      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH

      # Harvest Flutter build files
      - name: Harvest Flutter build files
        run: |
          heat dir build/windows/x64/runner/${{ github.event.inputs['build-type'] }} `
            -cg ProductComponents `
            -dr INSTALLFOLDER `
            -gg `
            -var var.BuildDir `
            -scom -sreg -sfrag -srd `
            -out windows/installer/components.wxs

      # Build MSI installer
      - name: Build MSI installer
        run: |
          mkdir installer_build
          candle windows/installer/main.wxs windows/installer/components.wxs `
            -dBuildDir=build/windows/x64/runner/${{ github.event.inputs['build-type'] }} `
            -out installer_build/
          light installer_build/*.wixobj -out ${{ github.event.inputs['msi-name'] }}

      # Upload MSI artifact
      - uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: ${{ github.event.inputs['msi-name'] }}
